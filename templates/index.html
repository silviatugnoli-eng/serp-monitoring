<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERP Monitor - Analisi Reputazione</title>
    <style>
        /* COLORI PERSONALIZZABILI - Modifica questi valori */
        :root {
            --primary-color: #a4404e;
            --secondary-color: #374c6f
            --accent-color: #cc9a65;
            --text-color: #333;
            --bg-light: #f8f9fa;
            --border-color: #e0e0e0;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 1.05em;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: white;
            cursor: pointer;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            display: none;
            margin-top: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--border-color);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .current-keyword {
            text-align: center;
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .result-item {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary-color);
        }
        
        .result-keyword {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 10px;
        }
        
        .result-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .stat {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.85em;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1em;
        }
        
        .download-btn {
            margin-top: 20px;
            background: var(--accent-color);
        }
        
        .download-btn:hover {
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
        }
        
        .hint {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box strong {
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîç SERP Monitor</h1>
            <p class="subtitle">Analisi Reputazione Online su Google e Bing</p>
            
            <form id="analysisForm">
                <div class="form-group">
                    <label for="keywords">Keywords da analizzare</label>
                    <textarea 
                        id="keywords" 
                        rows="8" 
                        placeholder="Inserisci una keyword per riga, esempio:&#10;Parola chiave 1&#10;Parola chiave 2&#10;Parola chiave 3"
                        required
                    ></textarea>
                    <p class="hint">üí° Una keyword per riga. Verranno cercate su Google e Bing.</p>
                </div>

                <div class="form-group">
                    <label for="sites">Limita ricerca a siti specifici (opzionale)</label>
                    <textarea 
                        id="sites" 
                        rows="4" 
                        placeholder="Inserisci un dominio per riga, esempio:&#10;corriere.it&#10;repubblica.it&#10;ilpost.it&#10;ansa.it"
                    ></textarea>
                    <p class="hint">üåê Se inserisci dei siti, la ricerca verr√† limitata solo a quei domini. Lascia vuoto per cercare ovunque.</p>
                </div>

                <div class="form-group">
                    <label for="numResults">Numero di risultati per motore</label>
                    <select id="numResults">
                        <option value="10">‚ö° 10 risultati (1 pagina, veloce)</option>
                        <option value="20">üìÑ 20 risultati (2 pagine)</option>
                        <option value="30" selected>üéØ 30 risultati (3 pagine, consigliato)</option>
                    </select>
                    <p class="hint">üìä Google ha cambiato le regole: max 10 risultati per pagina. Usiamo la paginazione per ottenere pi√π risultati.</p>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="includeImages" style="width: auto; margin-right: 10px; cursor: pointer;">
                        <span>üñºÔ∏è Includi ricerca Google Immagini</span>
                    </label>
                    <p class="hint">üì∏ Se attivato, cercher√† anche immagini su Google. I risultati andranno in un foglio Excel separato.</p>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="includeAI" style="width: auto; margin-right: 10px; cursor: pointer;" checked>
                        <span>ü§ñ Includi risposte AI (Google AI Overview + Bing Chat)</span>
                    </label>
                    <p class="hint">‚ú® Se attivato, include le risposte AI generate dai motori di ricerca. Costo: +1-2 crediti per keyword.</p>
                </div>
                
                <div class="form-group">
                    <label for="timeFilter">Periodo di ricerca</label>
                    <select id="timeFilter">
                        <option value="">üìÖ Tutte le notizie</option>
                        <option value="day">üÜï Solo ultime 24 ore</option>
                        <option value="week">üì∞ Ultima settimana</option>
                        <option value="month">üìä Ultimo mese</option>
                    </select>
                    <p class="hint">‚è∞ Filtra i risultati per data di pubblicazione</p>
                </div>
                
                <div class="form-group">
                    <label for="emails">Email per ricevere i risultati (opzionale)</label>
                    <input 
                        type="text" 
                        id="emails" 
                        placeholder="email1@esempio.com, email2@esempio.com, email3@esempio.com"
                    />
                    <p class="hint">üìß Puoi inserire pi√π email separate da virgola. Riceverai l'email con i link alle notizie + Excel allegato</p>
                </div>

                <div class="info-box">
                    <strong>‚ö†Ô∏è Importante per Piano Gratuito Mailgun:</strong><br>
                    Ogni email deve essere verificata su Mailgun prima di ricevere report. Max 5 destinatari. Funziona con Gmail, Yahoo, Libero, etc.
                </div>
                
                <button type="submit" class="btn" id="analyzeBtn">
                    Avvia Analisi
                </button>
            </form>
            
            <div class="progress-container" id="progressContainer">
                <div class="current-keyword" id="currentKeyword"></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>
            
            <div id="downloadSection" style="display: none; text-align: center; margin-top: 30px;">
                <button onclick="downloadExcel()" class="btn" style="width: 100%; padding: 15px; background: var(--accent-color);">
                    üì• Scarica Ultimo Report Excel
                </button>
            </div>
            
            <div class="results" id="results">
                <h2 style="margin-bottom: 20px; color: #333;">üìä Risultati</h2>
                <div id="resultsList"></div>
                <button class="btn download-btn" onclick="downloadExcel()">
                    üì• Scarica Report Excel
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('analysisForm');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const currentKeyword = document.getElementById('currentKeyword');
        const results = document.getElementById('results');
        const resultsList = document.getElementById('resultsList');
        const downloadSection = document.getElementById('downloadSection');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const keywordsText = document.getElementById('keywords').value.trim();
            const sitesText = document.getElementById('sites').value.trim();
            const emails = document.getElementById('emails').value.trim();
            const timeFilter = document.getElementById('timeFilter').value;
            const numResults = parseInt(document.getElementById('numResults').value);
            const includeImages = document.getElementById('includeImages').checked;
            const includeAI = document.getElementById('includeAI').checked;
            
            if (!keywordsText) {
                alert('Inserisci almeno una keyword!');
                return;
            }
            
            const keywords = keywordsText.split('\n').filter(k => k.trim() !== '');
            const sites = sitesText ? sitesText.split('\n').filter(s => s.trim() !== '') : [];
            
            if (keywords.length > 20) {
                alert('Massimo 20 keywords per analisi!');
                return;
            }
            
            // Avvia analisi
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="spinner"></span> Analisi in corso...';
            progressContainer.style.display = 'block';
            downloadSection.style.display = 'none';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        keywords, 
                        sites,
                        emails,
                        time_filter: timeFilter || null,
                        num_results: numResults,
                        include_images: includeImages,
                        include_ai: includeAI
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Errore avvio analisi');
                }
                
                // Monitora progresso
                monitorProgress();
                
            } catch (error) {
                alert('Errore: ' + error.message);
                resetUI();
            }
        });
        
        async function monitorProgress() {
            const checkStatus = async () => {
                try {
                    const response = await fetch('/status');
                    const status = await response.json();
                    
                    // Aggiorna UI
                    progressFill.style.width = status.progress + '%';
                    progressFill.textContent = status.progress + '%';
                    
                    if (status.current_keyword) {
                        currentKeyword.textContent = `üîé Analizzando: ${status.current_keyword}`;
                    }
                    
                    if (status.running) {
                        setTimeout(checkStatus, 1000);
                    } else {
                        // Analisi completata
                        displayResults(status.results);
                        downloadSection.style.display = 'block';
                        resetUI();
                    }
                } catch (error) {
                    console.error('Errore controllo stato:', error);
                    setTimeout(checkStatus, 2000);
                }
            };
            
            checkStatus();
        }
        
        function displayResults(data) {
            resultsList.innerHTML = '';
            
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <div class="result-keyword">${item.Keyword}</div>
                    <div class="result-stats">
                        <div class="stat">
                            <div class="stat-label">Google</div>
                            <div class="stat-value">${item['Risultati Google']} risultati</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Bing</div>
                            <div class="stat-value">${item['Risultati Bing']} risultati</div>
                        </div>
                    </div>
                `;
                resultsList.appendChild(div);
            });
            
            results.style.display = 'block';
        }
        
        function resetUI() {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Avvia Analisi';
        }
        
        async function downloadExcel() {
            try {
                const response = await fetch('/download');
                if (response.ok) {
                    window.location.href = '/download';
                } else {
                    alert('‚ö†Ô∏è Nessun report disponibile. Esegui prima un\'analisi!');
                }
            } catch (error) {
                alert('‚ö†Ô∏è Nessun report disponibile. Esegui prima un\'analisi!');
            }
        }
    </script>
</body>
</html>